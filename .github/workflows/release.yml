name: Release

on:
  push:
    tags:
      - "v*" # æ¨é€vå¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: "ç‰ˆæœ¬å· (å¦‚: v0.0.1)"
        required: true
        default: "v0.0.1"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build H5 version
        run: npm run build:h5

      - name: Build WeChat Mini Program
        run: |
          # å°è¯•æ„å»ºå¾®ä¿¡å°ç¨‹åºï¼Œå¦‚æœå¤±è´¥åˆ™è·³è¿‡
          npm run build:mp-weixin 2>/dev/null || echo "å¾®ä¿¡å°ç¨‹åºæ„å»ºå¤±è´¥æˆ–æœªé…ç½®ï¼Œå·²è·³è¿‡"

      - name: Build Alipay Mini Program
        run: |
          # å°è¯•æ„å»ºæ”¯ä»˜å®å°ç¨‹åºï¼Œå¦‚æœå¤±è´¥åˆ™è·³è¿‡
          npm run build:mp-alipay 2>/dev/null || echo "æ”¯ä»˜å®å°ç¨‹åºæ„å»ºå¤±è´¥æˆ–æœªé…ç½®ï¼Œå·²è·³è¿‡"

      - name: Get version from package.json
        id: package_version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          # è·å–æ ‡ç­¾å
          if [ -n "${{ github.ref_name }}" ]; then
            TAG="${{ github.ref_name }}"
          else
            TAG="v$(node -p "require('./package.json').version")"
          fi

          # è·å–æœ€è¿‘çš„æäº¤ä¿¡æ¯ï¼ˆæœ€å¤š20æ¡ï¼‰
          echo "è·å–æäº¤å†å²..."
          CHANGES=$(git log --oneline --no-merges -n 20 2>/dev/null || echo "é¦–æ¬¡å‘å¸ƒ")

          # æ£€æŸ¥æ„å»ºäº§ç‰©
          BUILD_OUTPUTS=""
          if [ -d "dist/build/h5" ]; then
            BUILD_OUTPUTS="$BUILD_OUTPUTS\n- **H5ç‰ˆæœ¬**: ä½äº \`dist/build/h5/\` ç›®å½•"
          fi
          if [ -d "dist/build/mp-weixin" ]; then
            BUILD_OUTPUTS="$BUILD_OUTPUTS\n- **å¾®ä¿¡å°ç¨‹åº**: ä½äº \`dist/build/mp-weixin/\` ç›®å½•"
          fi
          if [ -d "dist/build/mp-alipay" ]; then
            BUILD_OUTPUTS="$BUILD_OUTPUTS\n- **æ”¯ä»˜å®å°ç¨‹åº**: ä½äº \`dist/build/mp-alipay/\` ç›®å½•"
          fi

          if [ -z "$BUILD_OUTPUTS" ]; then
            BUILD_OUTPUTS="- **H5ç‰ˆæœ¬**: ä½äº \`dist/\` ç›®å½•"
          fi

          # åˆ›å»ºReleaseæ­£æ–‡
          cat > RELEASE_BODY.md << EOF
          ## ğŸš€ æ–°ç‰ˆæœ¬å‘å¸ƒ $TAG

          ### ğŸ“¦ æ„å»ºä¿¡æ¯
          - **ç‰ˆæœ¬å·**: $TAG
          - **æ„å»ºæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
          - **æäº¤**: ${{ github.sha }}

          ### ğŸ“ æœ€è¿‘æ›´æ–°
          \`\`\`
          $CHANGES
          \`\`\`

          ### ğŸ“ æ„å»ºäº§ç‰©
          $BUILD_OUTPUTS

          ### ğŸ“± Android/iOSåŸç”Ÿåº”ç”¨æ„å»ºæŒ‡å—

          #### æ–¹æ³•ä¸€ï¼šä½¿ç”¨HBuilderXï¼ˆæ¨èï¼‰
          1. **ä¸‹è½½HBuilderX**: https://www.dcloud.io/hbuilderx.html
          2. **å¯¼å…¥é¡¹ç›®**: æ‰“å¼€HBuilderX â†’ æ–‡ä»¶ â†’ å¯¼å…¥ â†’ é€‰æ‹©æœ¬é¡¹ç›®ç›®å½•
          3. **é…ç½®åŸç”Ÿæ‰“åŒ…**:
             - é€‰æ‹©é¡¹ç›® â†’ å‘è¡Œ â†’ åŸç”ŸApp-äº‘æ‰“åŒ…
             - é…ç½®åº”ç”¨åç§°ã€å›¾æ ‡ã€å¯åŠ¨å›¾ç­‰
             - é€‰æ‹©Android/iOSå¹³å°
             - é…ç½®è¯ä¹¦ï¼ˆiOSéœ€è¦è‹¹æœå¼€å‘è€…è´¦å·ï¼‰
          4. **å¼€å§‹æ‰“åŒ…**: ç‚¹å‡»æ‰“åŒ…æŒ‰é’®ï¼Œç­‰å¾…äº‘ç«¯æ„å»ºå®Œæˆ
          5. **ä¸‹è½½å®‰è£…åŒ…**: æ„å»ºå®Œæˆåä¸‹è½½apk/ipaæ–‡ä»¶

          #### æ–¹æ³•äºŒï¼šæœ¬åœ°Android Studioæ„å»ºï¼ˆä»…Androidï¼‰
          1. **ç”ŸæˆAndroidé¡¹ç›®**:
             \`\`\`bash
             # åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
             npm run build:app-plus
             \`\`\`
          2. **å¯¼å…¥Android Studio**:
             - æ‰“å¼€Android Studio
             - å¯¼å…¥ \`dist/build/app-plus/\` ç›®å½•
             - é…ç½®ç­¾åå’Œæ„å»ºå˜ä½“
          3. **æ„å»ºAPK**:
             - Build â†’ Generate Signed Bundle / APK
             - é€‰æ‹©APKï¼Œé…ç½®ç­¾åå¯†é’¥
             - é€‰æ‹©æ„å»ºç±»å‹ï¼ˆdebug/releaseï¼‰

          #### æ–¹æ³•ä¸‰ï¼šä½¿ç”¨uni-app CLI
          1. **å®‰è£…HBuilderX CLI**:
             \`\`\`bash
             # å…¨å±€å®‰è£…
             npm install -g @dcloudio/uni-cli-shared
             \`\`\`
          2. **æ„å»ºAndroidé¡¹ç›®**:
             \`\`\`bash
             # ç”ŸæˆAndroidé¡¹ç›®
             uni build --platform app-plus --target android
             \`\`\`
          3. **é¡¹ç›®ä½ç½®**: ç”Ÿæˆçš„é¡¹ç›®ä½äº \`dist/build/app-plus/\`

          ### âš ï¸ æ³¨æ„äº‹é¡¹
          1. **iOSæ„å»º**: éœ€è¦è‹¹æœå¼€å‘è€…è´¦å·ï¼ˆå¹´è´¹$99ï¼‰
          2. **è¯ä¹¦é…ç½®**: å¿…é¡»é…ç½®æ­£ç¡®çš„ç­¾åè¯ä¹¦
          3. **äº‘æ‰“åŒ…é™åˆ¶**: å…è´¹ç‰ˆæœ‰æ¬¡æ•°é™åˆ¶ï¼Œå»ºè®®ä½¿ç”¨æœ¬åœ°æ„å»º
          4. **ç‰ˆæœ¬å…¼å®¹**: ç¡®ä¿HBuilderXç‰ˆæœ¬ä¸uni-appç‰ˆæœ¬å…¼å®¹

          ### ğŸ”— ç›¸å…³èµ„æº
          - [uni-appå®˜æ–¹æ–‡æ¡£](https://uniapp.dcloud.net.cn/)
          - [HBuilderXä¸‹è½½](https://www.dcloud.io/hbuilderx.html)
          - [Android Studioä¸‹è½½](https://developer.android.com/studio)
          - [è‹¹æœå¼€å‘è€…è®¡åˆ’](https://developer.apple.com/programs/)

          ---

          *è‡ªåŠ¨ç”Ÿæˆäº GitHub Actions - ä¸“æ³¨äºåº”ç”¨æ„å»ºäº§ç‰©*
          EOF

          # è¾“å‡ºReleaseæ­£æ–‡
          RELEASE_BODY=$(cat RELEASE_BODY.md)
          echo "release_body<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Package build outputs
        run: |
          # åˆ›å»ºå‹ç¼©åŒ…ç›®å½•
          mkdir -p release-packages

          # å‹ç¼©H5ç‰ˆæœ¬ - ä¸»è¦æ„å»ºäº§ç‰©
          if [ -d "dist/build/h5" ]; then
            tar -czf release-packages/h5-build.tar.gz -C dist/build/h5 .
            echo "âœ… å·²æ‰“åŒ…H5ç‰ˆæœ¬: release-packages/h5-build.tar.gz"
            # è®¡ç®—æ–‡ä»¶å¤§å°
            H5_SIZE=$(du -h release-packages/h5-build.tar.gz | cut -f1)
            echo "H5ç‰ˆæœ¬å¤§å°: $H5_SIZE"
          elif [ -d "dist" ]; then
            tar -czf release-packages/h5-build.tar.gz -C dist .
            echo "âœ… å·²æ‰“åŒ…H5ç‰ˆæœ¬: release-packages/h5-build.tar.gz"
            H5_SIZE=$(du -h release-packages/h5-build.tar.gz | cut -f1)
            echo "H5ç‰ˆæœ¬å¤§å°: $H5_SIZE"
          else
            echo "âš ï¸  H5æ„å»ºç›®å½•ä¸å­˜åœ¨"
          fi

          # å‹ç¼©å¾®ä¿¡å°ç¨‹åº - å¯é€‰æ„å»ºäº§ç‰©
          if [ -d "dist/build/mp-weixin" ]; then
            tar -czf release-packages/wechat-miniprogram.tar.gz -C dist/build/mp-weixin .
            echo "âœ… å·²æ‰“åŒ…å¾®ä¿¡å°ç¨‹åº: release-packages/wechat-miniprogram.tar.gz"
            WECHAT_SIZE=$(du -h release-packages/wechat-miniprogram.tar.gz | cut -f1)
            echo "å¾®ä¿¡å°ç¨‹åºå¤§å°: $WECHAT_SIZE"
          else
            echo "â„¹ï¸  å¾®ä¿¡å°ç¨‹åºæ„å»ºç›®å½•ä¸å­˜åœ¨ï¼Œå·²è·³è¿‡"
          fi

          # å‹ç¼©æ”¯ä»˜å®å°ç¨‹åº - å¯é€‰æ„å»ºäº§ç‰©
          if [ -d "dist/build/mp-alipay" ]; then
            tar -czf release-packages/alipay-miniprogram.tar.gz -C dist/build/mp-alipay .
            echo "âœ… å·²æ‰“åŒ…æ”¯ä»˜å®å°ç¨‹åº: release-packages/alipay-miniprogram.tar.gz"
            ALIPAY_SIZE=$(du -h release-packages/alipay-miniprogram.tar.gz | cut -f1)
            echo "æ”¯ä»˜å®å°ç¨‹åºå¤§å°: $ALIPAY_SIZE"
          else
            echo "â„¹ï¸  æ”¯ä»˜å®å°ç¨‹åºæ„å»ºç›®å½•ä¸å­˜åœ¨ï¼Œå·²è·³è¿‡"
          fi

          # ä¸åˆ›å»ºæºä»£ç åŒ…ï¼Œåªä¿ç•™åº”ç”¨æ„å»ºäº§ç‰©
          echo "â„¹ï¸  è·³è¿‡æºä»£ç åŒ…åˆ›å»ºï¼Œä¸“æ³¨äºåº”ç”¨æ„å»ºäº§ç‰©"

      - name: Check files before release
        run: |
          echo "æ£€æŸ¥è¦ä¸Šä¼ çš„æ–‡ä»¶..."
          echo "=== release-packagesç›®å½• ==="
          ls -la release-packages/ 2>/dev/null || echo "release-packagesç›®å½•ä¸å­˜åœ¨"
          echo ""
          echo "=== åªä¸Šä¼ åº”ç”¨æ„å»ºäº§ç‰© ==="
          for file in release-packages/*; do
            if [ -e "$file" ]; then
              echo "âœ… åº”ç”¨æ„å»ºäº§ç‰©: $file"
            fi
          done

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: Release v${{ steps.package_version.outputs.version }}
          body: ${{ steps.release_notes.outputs.release_body }}
          draft: false
          prerelease: false
          generate_release_notes: false
          fail_on_unmatched_files: false
          files: |
            release-packages/*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: assistant-build-v${{ steps.package_version.outputs.version }}
          path: |
            release-packages/
          retention-days: 30

  # ç®€å•çš„ç‰ˆæœ¬æ›´æ–°æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
  check-version:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for version bump
        run: |
          # æ£€æŸ¥æœ€è¿‘çš„æäº¤æ˜¯å¦åŒ…å«ç‰ˆæœ¬æ›´æ–°
          if git log --oneline -n 5 | grep -i "release\|version\|bump\|chore(release)"; then
            echo "æ£€æµ‹åˆ°ç‰ˆæœ¬æ›´æ–°æäº¤"
            echo "å»ºè®®æ‰§è¡Œ: npm version patch && git push origin v\$(node -p \"require('./package.json').version\")"
          else
            echo "æœªæ£€æµ‹åˆ°ç‰ˆæœ¬æ›´æ–°æäº¤"
          fi
