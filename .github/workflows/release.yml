name: Release

on:
  push:
    tags:
      - "v*" # æ¨é€vå¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: "ç‰ˆæœ¬å· (å¦‚: v0.0.1)"
        required: true
        default: "v0.0.1"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build H5 version
        run: npm run build:h5

      - name: Build WeChat Mini Program
        run: |
          # å°è¯•æ„å»ºå¾®ä¿¡å°ç¨‹åºï¼Œå¦‚æœå¤±è´¥åˆ™è·³è¿‡
          npm run build:mp-weixin 2>/dev/null || echo "å¾®ä¿¡å°ç¨‹åºæ„å»ºå¤±è´¥æˆ–æœªé…ç½®ï¼Œå·²è·³è¿‡"

      - name: Build Alipay Mini Program
        run: |
          # å°è¯•æ„å»ºæ”¯ä»˜å®å°ç¨‹åºï¼Œå¦‚æœå¤±è´¥åˆ™è·³è¿‡
          npm run build:mp-alipay 2>/dev/null || echo "æ”¯ä»˜å®å°ç¨‹åºæ„å»ºå¤±è´¥æˆ–æœªé…ç½®ï¼Œå·²è·³è¿‡"

      - name: Get version from package.json
        id: package_version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          # è·å–æ ‡ç­¾å
          if [ -n "${{ github.ref_name }}" ]; then
            TAG="${{ github.ref_name }}"
          else
            TAG="v$(node -p "require('./package.json').version")"
          fi

          # è·å–æœ€è¿‘çš„æäº¤ä¿¡æ¯ï¼ˆæœ€å¤š20æ¡ï¼‰
          echo "è·å–æäº¤å†å²..."
          CHANGES=$(git log --oneline --no-merges -n 20 2>/dev/null || echo "é¦–æ¬¡å‘å¸ƒ")

          # æ£€æŸ¥æ„å»ºäº§ç‰©
          BUILD_OUTPUTS=""
          if [ -d "dist/build/h5" ]; then
            BUILD_OUTPUTS="$BUILD_OUTPUTS\n- **H5ç‰ˆæœ¬**: ä½äº \`dist/build/h5/\` ç›®å½•"
          fi
          if [ -d "dist/build/mp-weixin" ]; then
            BUILD_OUTPUTS="$BUILD_OUTPUTS\n- **å¾®ä¿¡å°ç¨‹åº**: ä½äº \`dist/build/mp-weixin/\` ç›®å½•"
          fi
          if [ -d "dist/build/mp-alipay" ]; then
            BUILD_OUTPUTS="$BUILD_OUTPUTS\n- **æ”¯ä»˜å®å°ç¨‹åº**: ä½äº \`dist/build/mp-alipay/\` ç›®å½•"
          fi

          if [ -z "$BUILD_OUTPUTS" ]; then
            BUILD_OUTPUTS="- **H5ç‰ˆæœ¬**: ä½äº \`dist/\` ç›®å½•"
          fi

          # åˆ›å»ºReleaseæ­£æ–‡
          cat > RELEASE_BODY.md << EOF
          ## ğŸš€ æ–°ç‰ˆæœ¬å‘å¸ƒ $TAG

          ### ğŸ“¦ æ„å»ºä¿¡æ¯
          - **ç‰ˆæœ¬å·**: $TAG
          - **æ„å»ºæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
          - **æäº¤**: ${{ github.sha }}

          ### ğŸ“ æœ€è¿‘æ›´æ–°
          \`\`\`
          $CHANGES
          \`\`\`

          ### ğŸ“ æ„å»ºäº§ç‰©
          $BUILD_OUTPUTS

          ### ğŸ”§ ä½¿ç”¨è¯´æ˜
          1. **H5ç‰ˆæœ¬**: å¯ç›´æ¥éƒ¨ç½²åˆ°WebæœåŠ¡å™¨
          2. **å¾®ä¿¡å°ç¨‹åº**: ä½¿ç”¨å¾®ä¿¡å¼€å‘è€…å·¥å…·å¯¼å…¥ \`dist/build/mp-weixin/\` ç›®å½•
          3. **æ”¯ä»˜å®å°ç¨‹åº**: ä½¿ç”¨æ”¯ä»˜å®å¼€å‘è€…å·¥å…·å¯¼å…¥ \`dist/build/mp-alipay/\` ç›®å½•
          4. **Android/iOS**: éœ€ä½¿ç”¨HBuilderXè¿›è¡ŒåŸç”Ÿæ‰“åŒ…

          ### ğŸš€ å¤šç«¯æ”¯æŒ
          æœ¬é¡¹ç›®åŸºäºUniAppå¼€å‘ï¼Œæ”¯æŒä»¥ä¸‹å¹³å°ï¼š
          - ğŸ“± H5ç½‘é¡µç‰ˆ
          - ğŸ’¬ å¾®ä¿¡å°ç¨‹åº
          - ğŸ’° æ”¯ä»˜å®å°ç¨‹åº
          - ğŸ¤– AndroidåŸç”Ÿåº”ç”¨
          - ğŸ iOSåŸç”Ÿåº”ç”¨

          ---

          *è‡ªåŠ¨ç”Ÿæˆäº GitHub Actions*
          EOF

          # è¾“å‡ºReleaseæ­£æ–‡
          RELEASE_BODY=$(cat RELEASE_BODY.md)
          echo "release_body<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Package build outputs
        run: |
          # åˆ›å»ºå‹ç¼©åŒ…
          mkdir -p release-packages

          # å‹ç¼©H5ç‰ˆæœ¬
          if [ -d "dist/build/h5" ]; then
            tar -czf release-packages/h5-build.tar.gz -C dist/build/h5 .
            echo "å·²æ‰“åŒ…H5ç‰ˆæœ¬: release-packages/h5-build.tar.gz"
          elif [ -d "dist" ]; then
            tar -czf release-packages/h5-build.tar.gz -C dist .
            echo "å·²æ‰“åŒ…H5ç‰ˆæœ¬: release-packages/h5-build.tar.gz"
          fi

          # å‹ç¼©å¾®ä¿¡å°ç¨‹åº
          if [ -d "dist/build/mp-weixin" ]; then
            tar -czf release-packages/wechat-miniprogram.tar.gz -C dist/build/mp-weixin .
            echo "å·²æ‰“åŒ…å¾®ä¿¡å°ç¨‹åº: release-packages/wechat-miniprogram.tar.gz"
          fi

          # å‹ç¼©æ”¯ä»˜å®å°ç¨‹åº
          if [ -d "dist/build/mp-alipay" ]; then
            tar -czf release-packages/alipay-miniprogram.tar.gz -C dist/build/mp-alipay .
            echo "å·²æ‰“åŒ…æ”¯ä»˜å®å°ç¨‹åº: release-packages/alipay-miniprogram.tar.gz"
          fi

          # åˆ›å»ºå®Œæ•´çš„æºä»£ç åŒ…
          tar -czf release-packages/source-code.tar.gz --exclude='node_modules' --exclude='.git' .
          echo "å·²æ‰“åŒ…æºä»£ç : release-packages/source-code.tar.gz"

      - name: Check files before release
        run: |
          echo "æ£€æŸ¥è¦ä¸Šä¼ çš„æ–‡ä»¶..."
          echo "=== release-packagesç›®å½• ==="
          ls -la release-packages/ 2>/dev/null || echo "release-packagesç›®å½•ä¸å­˜åœ¨"
          echo ""
          echo "=== æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ ==="
          for file in release-packages/* package.json README.md LICENSE; do
            if [ -e "$file" ]; then
              echo "âœ… æ–‡ä»¶å­˜åœ¨: $file"
            else
              echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $file"
            fi
          done

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: Release v${{ steps.package_version.outputs.version }}
          body: ${{ steps.release_notes.outputs.release_body }}
          draft: false
          prerelease: false
          generate_release_notes: false
          make_latest: true
          fail_on_unmatched_files: false
          files: |
            release-packages/*
            package.json
            README.md
            LICENSE

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: assistant-build-v${{ steps.package_version.outputs.version }}
          path: |
            release-packages/
            dist/
            package.json
          retention-days: 30

  # ç®€å•çš„ç‰ˆæœ¬æ›´æ–°æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
  check-version:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for version bump
        run: |
          # æ£€æŸ¥æœ€è¿‘çš„æäº¤æ˜¯å¦åŒ…å«ç‰ˆæœ¬æ›´æ–°
          if git log --oneline -n 5 | grep -i "release\|version\|bump\|chore(release)"; then
            echo "æ£€æµ‹åˆ°ç‰ˆæœ¬æ›´æ–°æäº¤"
            echo "å»ºè®®æ‰§è¡Œ: npm version patch && git push origin v\$(node -p \"require('./package.json').version\")"
          else
            echo "æœªæ£€æµ‹åˆ°ç‰ˆæœ¬æ›´æ–°æäº¤"
          fi
