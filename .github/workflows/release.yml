name: Release

on:
  push:
    tags:
      - "v*" # æ¨é€vå¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: "ç‰ˆæœ¬å· (å¦‚: v0.0.1)"
        required: true
        default: "v0.0.1"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build:h5

      - name: Get version from package.json
        id: package_version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          # è·å–æ ‡ç­¾å
          if [ -n "${{ github.ref_name }}" ]; then
            TAG="${{ github.ref_name }}"
          else
            TAG="v$(node -p "require('./package.json').version")"
          fi

          # è·å–æœ€è¿‘çš„æäº¤ä¿¡æ¯ï¼ˆæœ€å¤š20æ¡ï¼‰
          echo "è·å–æäº¤å†å²..."
          CHANGES=$(git log --oneline --no-merges -n 20 2>/dev/null || echo "é¦–æ¬¡å‘å¸ƒ")

          # åˆ›å»ºReleaseæ­£æ–‡
          cat > RELEASE_BODY.md << EOF
          ## ğŸš€ æ–°ç‰ˆæœ¬å‘å¸ƒ $TAG

          ### ğŸ“¦ æ„å»ºä¿¡æ¯
          - **ç‰ˆæœ¬å·**: $TAG
          - **æ„å»ºæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
          - **æäº¤**: ${{ github.sha }}

          ### ğŸ“ æœ€è¿‘æ›´æ–°
          \`\`\`
          $CHANGES
          \`\`\`

          ### ğŸ“ æ„å»ºäº§ç‰©
          æ„å»ºå®Œæˆçš„åº”ç”¨ä½äº \`dist/\` ç›®å½•ä¸­ã€‚

          ### ğŸ”§ ä½¿ç”¨è¯´æ˜
          1. H5ç‰ˆæœ¬å¯ç›´æ¥éƒ¨ç½²åˆ°WebæœåŠ¡å™¨
          2. å°ç¨‹åºç‰ˆæœ¬éœ€ä½¿ç”¨å¯¹åº”å¹³å°å¼€å‘è€…å·¥å…·å¯¼å…¥

          ---

          *è‡ªåŠ¨ç”Ÿæˆäº GitHub Actions*
          EOF

          # è¾“å‡ºReleaseæ­£æ–‡
          RELEASE_BODY=$(cat RELEASE_BODY.md)
          echo "release_body<<EOF" >> $GITHUB_OUTPUT
          echo "$RELEASE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: Release v${{ steps.package_version.outputs.version }}
          body: ${{ steps.release_notes.outputs.release_body }}
          draft: false
          prerelease: false
          generate_release_notes: false
          files: |
            dist/**
            package.json
            README.md
            LICENSE

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: assistant-build-v${{ steps.package_version.outputs.version }}
          path: |
            dist/
            package.json
          retention-days: 30

  # ç®€å•çš„ç‰ˆæœ¬æ›´æ–°æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
  check-version:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for version bump
        run: |
          # æ£€æŸ¥æœ€è¿‘çš„æäº¤æ˜¯å¦åŒ…å«ç‰ˆæœ¬æ›´æ–°
          if git log --oneline -n 5 | grep -i "release\|version\|bump\|chore(release)"; then
            echo "æ£€æµ‹åˆ°ç‰ˆæœ¬æ›´æ–°æäº¤"
            echo "å»ºè®®æ‰§è¡Œ: npm version patch && git push origin v\$(node -p \"require('./package.json').version\")"
          else
            echo "æœªæ£€æµ‹åˆ°ç‰ˆæœ¬æ›´æ–°æäº¤"
          fi
